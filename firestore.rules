rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------
    // USERS COLLECTION
    // ---------------------------
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    match /partialCreatedUser/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }


    //  && (
    //     request.auth.uid == userId || request.auth.token.role == "admin"
    //   );

    // ---------------------------
    // JOB REQUESTS
    // ---------------------------
    match /job_requests/{jobId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null; // Any authenticated user can see jobs
      allow update: if request.auth != null 
      // && (
      //   request.auth.uid == resource.data.clientId || request.auth.token.role == "admin"
      // );
      allow delete: if request.auth != null;
      // && request.auth.token.role == "admin";
    }

    // ---------------------------
    // JOB ASSIGNMENTS
    // ---------------------------
    match /job_assignments/{assignmentId} {
      allow create: if request.auth != null; // && request.auth.token.role == "admin"; // Admin creates assignment
      allow read: if request.auth != null;
      // && (
      //   request.auth.uid == resource.data.workerId ||
      //   request.auth.uid == resource.data.clientId ||
      //   request.auth.token.role == "admin"
      // );
      allow update: if request.auth != null;
      // && (
      //   request.auth.uid == resource.data.workerId ||
      //   request.auth.token.role == "admin"
      // ); // Worker updates progress, admin can update everything
    }

    // ---------------------------
    // PAYMENTS
    // ---------------------------
    match /payments/{paymentId} {
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.clientId ||
        request.auth.uid == resource.data.workerId ||
        request.auth.token.role == "admin"
      );
      allow write: if request.auth != null && request.auth.token.role == "admin";
    }

    // ---------------------------
    // WORKER REVIEWS
    // ---------------------------
    match /worker_reviews/{reviewId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.reviewerId;
      allow read: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.token.role == "admin";
    }
    

    match /activity_logs/{activityId} {
      allow create: if true;
      allow read: if true;
    }

    // ---------------------------
    // HELPER FUNCTIONS (Optional)
    // ---------------------------
    // function isAdmin() {
    //   return request.auth.token.role == "admin";
    // }

    // function isWorker() {
    //   return request.auth.token.role == "worker";
    // }

    // function isClient() {
    //   return request.auth.token.role == "client";
    // }
  }
}
